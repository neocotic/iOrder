<!DOCTYPE html>

<html>
<head>
  <title>background.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="background.html">
                background.coffee
              </a>
            
              
              <a class="source" href="install.html">
                install.coffee
              </a>
            
              
              <a class="source" href="notification.html">
                notification.coffee
              </a>
            
              
              <a class="source" href="options.html">
                options.coffee
              </a>
            
              
              <a class="source" href="popup.html">
                popup.coffee
              </a>
            
              
              <a class="source" href="utils.html">
                utils.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>background.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p><a href="http://neocotic.com/iOrder">iOrder</a><br>(c) 2013 Alasdair Mercer<br>Freely distributable under the MIT license.<br>For all details and documentation:<br><a href="http://neocotic.com/iOrder">http://neocotic.com/iOrder</a></p>
<h3>Private constants</h3>
<p>Domain of this extension&#39;s homepage.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>HOMEPAGE_DOMAIN = <span class="string">'neocotic.com'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Base URL (incl. domain and path) of order pages on the Apple US store.<br>The remaining path segments include the number and delivery zip/post
code, in that order.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>ORDER_URL       = <span class="string">'https://store.apple.com/us/order/guest/'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>URL of the Apple US store orders list for an account.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>ORDERS_URL      = <span class="string">'https://store.apple.com/us/order/list'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>List of recognised order status used by the Apple US store.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>STATUS          = [
                    <span class="string">'We\'ve received your order'</span>
                    <span class="string">'Processing Items'</span>
                    <span class="string">'Preparing for Shipment'</span>
                    <span class="string">'Shipped'</span>
                    <span class="string">'Complete'</span>
                  ]</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Base URL (incl. domain) of the track link on the Apple US store order page.<br>This should be used to find and extract the track URL for a specific order.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>TRACKER_URL     = <span class="string">'https://applestore.bridge-point.com/'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h3>Private variables</h3>
<p>Number of status updates since the user last cleared it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>updates = <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Current version of iOrder.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>version = <span class="string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h3>Private functions</h3>
<p>Build the HTML to populate the popup with to optimize popup loading times.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">buildPopup</span></span> = -&gt;
  errors  = <span class="literal">no</span>
  footer  = $ <span class="string">'&lt;footer/&gt;'</span>
  footerF = $ <span class="string">'&lt;div/&gt;'</span>
  footerL = $ <span class="string">'&lt;div/&gt;'</span>
  header  = $ <span class="string">'&lt;header/&gt;'</span>
  headerF = $ <span class="string">'&lt;div/&gt;'</span>
  headerL = $ <span class="string">'&lt;div/&gt;'</span>
  table   = $ <span class="string">'&lt;table id="orders"/&gt;'</span>
  tbody   = $ <span class="string">'&lt;tbody/&gt;'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Add two empty divs to both the header and footer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  footer.append footerF, footerL
  header.append headerF, headerL</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Add the header links (Options, Orders).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  headerL.append $ <span class="string">'&lt;a/&gt;'</span>,
    href:    <span class="string">'#'</span>
    id:      <span class="string">'optionsLink'</span>
    text:    utils.i18n <span class="string">'options_text'</span>
    title:   utils.i18n <span class="string">'options_title'</span>
  headerL.append $ <span class="string">'&lt;a/&gt;'</span>,
    href:    <span class="string">'#'</span>
    id:      <span class="string">'ordersLink'</span>
    text:    utils.i18n <span class="string">'orders_text'</span>
    title:   utils.i18n <span class="string">'orders_title'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Add the refresh button to the footer (can be removed though).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  footerF.append $ <span class="string">'&lt;button/&gt;'</span>,
    id:      <span class="string">'refreshLink'</span>
    text:    utils.i18n <span class="string">'refresh_text'</span>
    title:   utils.i18n <span class="string">'refresh_title'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Change the refresh button to show I&#39;m busy... I am y&#39;know.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> updateManager.updating
    footerF.find(<span class="string">'button:first-child'</span>).attr(
      disabled: <span class="string">'disabled'</span>
      title:    utils.i18n <span class="string">'refreshing_title'</span>
    ).html utils.i18n <span class="string">'refreshing_text'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Add the clear button if badges are visibile; they can be distracting.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> updates <span class="keyword">and</span> utils.get <span class="string">'badges'</span>
    footerF.append $ <span class="string">'&lt;button/&gt;'</span>,
      id:      <span class="string">'clearLink'</span>
      text:    utils.i18n <span class="string">'clear_text'</span>
      title:   utils.i18n <span class="string">'clear_title'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Add the update details to the footer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  footerL.append $ <span class="string">'&lt;span/&gt;'</span>,
    text: utils.i18n(<span class="string">'popup_footer_text'</span>, [
      <span class="keyword">new</span> Date(utils.get <span class="string">'lastUpdated'</span>).format <span class="string">'H:i'</span>
      getFrequency().text
    ])</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Add the column headers to the orders table.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $(<span class="string">'&lt;thead/&gt;'</span>).append(
    $.prototype.append.apply $(<span class="string">'&lt;tr/&gt;'</span>), [
      $ <span class="string">'&lt;th/&gt;'</span>, text: utils.i18n <span class="string">'order_header'</span>
      $ <span class="string">'&lt;th/&gt;'</span>, text: utils.i18n <span class="string">'status_header'</span>
      $ <span class="string">'&lt;th/&gt;'</span>, text: utils.i18n <span class="string">'actions_header'</span>
    ]
  ).appendTo table</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Add the table body which will contain the orders.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  table.append tbody</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>No orders exist so fill the blank and hide the refresh link.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">unless</span> ext.orders.length
    $(<span class="string">'&lt;tr/&gt;'</span>).append(
      $(<span class="string">'&lt;td/&gt;'</span>,
        class:   <span class="string">'empty'</span>
        colspan: <span class="number">3</span>
      ).html utils.i18n <span class="string">'no_orders_text'</span>
    ).appendTo tbody
    footer.find(<span class="string">'#refreshLink'</span>).remove()</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Otherwise; let&#39;s create a row for each order.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">for</span> order <span class="keyword">in</span> ext.orders
    tbody.append(
      $.prototype.append.apply $(<span class="string">'&lt;tr/&gt;'</span>), [
        $.prototype.append.apply $(<span class="string">'&lt;td/&gt;'</span>), [
          $ <span class="string">'&lt;strong/&gt;'</span>, text: order.label
          <span class="string">'&lt;br /&gt;'</span>
          $ <span class="string">'&lt;a/&gt;'</span>,
            <span class="string">'data-order-code'</span>:   order.code
            <span class="string">'data-order-number'</span>: order.number
            href:                <span class="string">'#'</span>
            text:                order.number
            title:               utils.i18n <span class="string">'order_title'</span>
        ]
        $(<span class="string">'&lt;td/&gt;'</span>).append $ <span class="string">'&lt;span/&gt;'</span>, text: getStatusText order
      ]
    )</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Order had an error; I suppose I should tell the user.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> order.error
      errors = <span class="literal">yes</span>
      tbody.find(<span class="string">'tr:last-child td:first-child strong'</span>).attr
        class: <span class="string">'error'</span>
        title: utils.i18n order.error</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Found the track link so I&#39;ll share it with the user. I&#39;m good like that.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> order.trackingUrl
      tbody.find(<span class="string">'tr:last-child'</span>).append $(<span class="string">'&lt;td/&gt;'</span>).append $ <span class="string">'&lt;a/&gt;'</span>,
          <span class="string">'data-order-code'</span>:   order.code
          <span class="string">'data-order-number'</span>: order.number
          href:                <span class="string">'#'</span>
          text:                utils.i18n <span class="string">'track_text'</span>
          title:               utils.i18n <span class="string">'track_title'</span>
    <span class="keyword">else</span>
      tbody.find(<span class="string">'tr:last-child'</span>).append $(<span class="string">'&lt;td/&gt;'</span>).append <span class="string">' '</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>One or more order has an error so I&#39;ll add a little icon.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> errors
    $(<span class="string">'&lt;img/&gt;'</span>,
      height: <span class="number">14</span>
      id:     <span class="string">'errorIcon'</span>
      src:    <span class="string">'../images/exclamation_red.png'</span>
      title:  utils.i18n <span class="string">'update_errors_text'</span>
      width:  <span class="number">14</span>
    ).prependTo footerL
  ext.popupHtml = $(<span class="string">'&lt;div/&gt;'</span>).append(header, table, footer).html()</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Inject and execute <code>install.coffee</code> within each of the tabs provided (where
valid).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">executeScriptsInExistingTabs</span></span> = (tabs) -&gt;
  <span class="keyword">for</span> tab <span class="keyword">in</span> tabs <span class="keyword">when</span> tab.url.indexOf(HOMEPAGE_DOMAIN) <span class="keyword">isnt</span> -<span class="number">1</span>
    chrome.tabs.executeScript tab.id, file: <span class="string">'lib/install.js'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Inject and execute <code>install.coffee</code> within all the tabs (where valid) of each
Chrome window.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">executeScriptsInExistingWindows</span></span> = -&gt;
  chrome.windows.getAll <span class="literal">null</span>, (windows) -&gt;
    <span class="keyword">for</span> win <span class="keyword">in</span> windows
      chrome.tabs.query windowId: win.id, executeScriptsInExistingTabs</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Attempt to retrieve the details for the persisted update frequency.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">getFrequency</span></span> = -&gt;
  frequency = utils.get <span class="string">'frequency'</span>
  <span class="keyword">return</span> freq <span class="keyword">for</span> freq <span class="keyword">in</span> ext.FREQUENCIES <span class="keyword">when</span> freq.value <span class="keyword">is</span> frequency</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Return the number of status updates detected by this extension for an order
since the specified time.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">getOrderStatusUpdates</span></span> = (order, lastRead) -&gt;
  count = <span class="number">0</span>
  count++ <span class="keyword">for</span> update <span class="keyword">in</span> order.updates <span class="keyword">when</span> update.timeStamp &gt; lastRead
  <span class="keyword">return</span> count</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Return the URL of the page on the Apple US store for the specified order.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">getOrderUrl</span></span> = (order) -&gt;
  encode = encodeURIComponent
  <span class="keyword">return</span> <span class="string">"<span class="subst">#{ORDER_URL}</span><span class="subst">#{encode order.number}</span>/<span class="subst">#{encode order.code}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Attempt to derive the status text to be displayed for the order.<br>The status text will either be that of the latest update or a single
whitespace character if no status updates have been detected yet for that
order.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">getStatusText</span></span> = (order) -&gt;
  length = order.updates?.length
  <span class="keyword">return</span> <span class="string">' '</span> <span class="keyword">unless</span> length
  <span class="keyword">return</span> order.updates[length - <span class="number">1</span>].status</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Return the total number of detected status updates for all existing orders
since the last time badges were cleared.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">getStatusUpdates</span></span> = -&gt;
  count    = <span class="number">0</span>
  lastRead = utils.get <span class="string">'lastRead'</span>
  count += getOrderStatusUpdates order, lastRead <span class="keyword">for</span> order <span class="keyword">in</span> ext.orders
  <span class="keyword">return</span> count</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Return all windows managed by this extension that are displaying a page that
begins with the specified URL.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">getWindows</span></span> = (url) -&gt;
  <span class="keyword">return</span> chrome.extension.getViews(type: <span class="string">'tab'</span>).filter (element) -&gt;
    <span class="keyword">return</span> element.location.href.indexOf(url) <span class="keyword">is</span> <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Handle the conversion/removal of older version of settings that may have
been stored previously by <code>ext.init</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">init_update</span></span> = -&gt;
  update_progress = utils.get <span class="string">'update_progress'</span>
  update_progress.settings ?= []</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Check if the settings need updated for 1.1.0.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> update_progress.settings.indexOf(<span class="string">'1.1.0'</span>) <span class="keyword">is</span> -<span class="number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Update the settings for 1.1.0.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    freq      = ext.FREQUENCIES[<span class="number">1</span>].value
    frequency = utils.get <span class="string">'frequency'</span>
    utils.set <span class="string">'frequency'</span>, freq <span class="keyword">if</span> frequency &gt; -<span class="number">1</span> <span class="keyword">and</span> frequency &lt; freq</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Ensure that settings are not updated for 1.1.0 again.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    update_progress.settings.push <span class="string">'1.1.0'</span>
    utils.set <span class="string">'update_progress'</span>, update_progress</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Initialize the persisted managed orders.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">initOrders</span></span> = -&gt;
  utils.init <span class="string">'orders'</span>, []
  ext.orders = utils.get <span class="string">'orders'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Determine whether or not an order already has the specified status.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">isOrderStatusNew</span></span> = (order, status) -&gt;
  <span class="keyword">return</span> <span class="literal">no</span> <span class="keyword">for</span> update <span class="keyword">in</span> order.updates <span class="keyword">when</span> update.status <span class="keyword">is</span> status
  <span class="keyword">return</span> <span class="literal">yes</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Determine whether or not the specified status is recognised by iOrder.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">isValidOrderStatus</span></span> = (status) -&gt;
  <span class="keyword">return</span> status <span class="keyword">in</span> STATUS</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Ensure any badge notification is cleared.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">markRead</span></span> = (retainTimeStamp) -&gt;
  updates = <span class="number">0</span>
  utils.set <span class="string">'lastRead'</span>, $.now() <span class="keyword">unless</span> retainTimeStamp
  setBadge()</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Update the UI so the clear button vanishes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  updatePopup()</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Attempt to notify the user of any unread status updates.<br>If there are no status updates, remove any visible badge.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">notify</span></span> = -&gt;
  oldUpdates = updates
  updates = getStatusUpdates()</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Update/clear badge depending on setting and updates available.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setBadge <span class="keyword">if</span> utils.get <span class="string">'badges'</span> <span class="keyword">then</span> updates <span class="keyword">or</span> <span class="string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Show the notification if setting enabled and has new updates.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> updates &gt; oldUpdates <span class="keyword">and</span> utils.get <span class="string">'notifications'</span>
    webkitNotifications.createHTMLNotification(
      chrome.extension.getURL <span class="string">'pages/notification.html'</span>
    ).show()</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Listener for internal requests.<br>This function will handle the request based on its type and the data
provided.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">onRequest</span></span> = (request, sender, sendResponse) -&gt;
  order   = {}
  url     = <span class="string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Check what needs to be done... and then do it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">switch</span> request.type
    <span class="keyword">when</span> <span class="string">'clear'</span> <span class="keyword">then</span> markRead()
    <span class="keyword">when</span> <span class="string">'options'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Try using existing tabs for the options page before creating one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      url = chrome.extension.getURL <span class="string">'pages/options.html'</span>
      selectOrCreateTab url, (isNew) -&gt;
        <span class="keyword">return</span> <span class="keyword">if</span> isNew
        win.options.refresh() <span class="keyword">for</span> win <span class="keyword">in</span> getWindows url
    <span class="keyword">when</span> <span class="string">'refresh'</span> <span class="keyword">then</span> updateManager.restart()
    <span class="keyword">when</span> <span class="string">'track'</span>
      order = ext.getOrder request.data.number, request.data.code
      chrome.tabs.create url: order.trackingUrl <span class="keyword">if</span> order <span class="keyword">and</span> order.trackingUrl
    <span class="keyword">when</span> <span class="string">'viewAll'</span> <span class="keyword">then</span> chrome.tabs.create url: ORDERS_URL
    <span class="keyword">when</span> <span class="string">'view'</span>
      order = ext.getOrder request.data.number, request.data.code
      chrome.tabs.create url: getOrderUrl order <span class="keyword">if</span> order</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Attempt to select a tab in the current window displaying a page whose
location begins with the specified URL.<br>If no existing tab exists a new one is simply created.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">selectOrCreateTab</span></span> = (url, callback) -&gt;
  chrome.windows.getCurrent (win) -&gt;
    chrome.tabs.query windowId: win.id, (tabs) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Try to find an existing tab.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">for</span> tab <span class="keyword">in</span> tabs
        <span class="keyword">if</span> tab.url.indexOf(url) <span class="keyword">is</span> <span class="number">0</span>
          existingTab = tab
          <span class="keyword">break</span>
      <span class="keyword">if</span> existingTab</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Found one! Now to select it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        chrome.tabs.update existingTab.id, selected: <span class="literal">yes</span>
        callback? <span class="literal">no</span>
      <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Ach well, let&#39;s just create a new one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        chrome.tabs.create url: url
        callback? <span class="literal">yes</span></pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Set the badge text to the specified string.<br>If no string is specified the badge is cleared.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">setBadge</span></span> = (str = <span class="string">''</span>) -&gt;
  chrome.browserAction.setBadgeText text: String str</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Send an AJAX request to the specified order&#39;s page on the Apple US store and
parses the response to update the order&#39;s properties.<br>If an <em>error</em> occurs during the update process assign a short description to
<code>order.error</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">updateOrder</span></span> = (order, callback) -&gt;
  $.get(getOrderUrl(order), (data) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Probably won&#39;t happen; more of a sanity check.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> order.error = <span class="string">'update_invalid_page_error'</span> <span class="keyword">unless</span> data</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Extract the relevant elements wrapped in jQuery goodness.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    heading     = $(data).find <span class="string">'.order .delivery-group .sb-heading'</span>
    status      = heading.find <span class="string">'h4 span:first-child'</span>
    trackingUrl = heading.find <span class="string">".group-actions tr:first-child td
 a[href^='<span class="subst">#{TRACKER_URL}</span>']"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Dig deeper and try and get the actual values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    status      = <span class="keyword">if</span> status.length <span class="keyword">then</span> status.text() <span class="keyword">else</span> <span class="string">''</span>
    trackingUrl = <span class="keyword">if</span> trackingUrl.length <span class="keyword">then</span> trackingUrl.attr <span class="string">'href'</span> <span class="keyword">else</span> <span class="string">''</span>
    <span class="keyword">if</span> status</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>A possible status was found but is it valid?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> isValidOrderStatus status</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>OK, it was valid; but is it new???</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> isOrderStatusNew order, status</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Right! It was valid and new! Just add it already.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          order.updates.push
            status:    status
            timeStamp: $.now()
      <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Extension could need updated if it gets here.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> order.error = <span class="string">'update_invalid_status_error'</span>
    <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Bad user data or extension could need updated.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">return</span> order.error = <span class="string">'update_status_not_found_error'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Only update the Track link if it was found.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    order.trackingUrl = trackingUrl <span class="keyword">if</span> trackingUrl</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Clear any pre-existing errors.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    order.error = <span class="string">''</span>
  ).error(-&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Something went wrong.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    order.error = <span class="string">'update_page_not_found_error'</span>
  ).complete -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Done! Now let&#39;s tell the boss.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    callback?.apply updateManager, [order]</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Build the HTML to populate the popup with to optimize popup loading times and
updates any popup currently being displayed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">updatePopup</span></span> = -&gt;
  buildPopup()
  popup = chrome.extension.getViews(type: <span class="string">'popup'</span>)[<span class="number">0</span>]
  popup.document.body.innerHTML = ext.popupHtml <span class="keyword">if</span> popup</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <h3>Update Manager setup</h3>
<p>Central manager for updating the orders.<br>This manager can handle concurrent start, stop and restart requests while also
supporting repeat (looping) functionality.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>updateManager =</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Unique interval identifier used to managed repeating updates.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  id: <span class="literal">undefined</span></pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Message stack used by the current update process.<br>Any start/stop/restart requests made while the manager is updating is added
to this stack and actioned upon completion of the process.
Afterwards, the stack is cleared for the next process.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  messages: []</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Indicate whether or not the update manager is currently running through an
update process.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  updating: <span class="literal">no</span></pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Restart the update manager, which may run once or start a repeating cycle
based on the current update frequency.<br>If this is called during an active update process the manager will restart
upon completion.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  restart: -&gt;
    frequency = utils.get <span class="string">'frequency'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>I&#39;m busy; I&#39;ll do it later.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> <span class="keyword">this</span>.messages.push <span class="string">'restart'</span> <span class="keyword">if</span> <span class="property">@updating</span></pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Clear the current cycle, where applicable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> <span class="property">@id</span>
      clearInterval <span class="property">@id</span></pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Ensure that it is disabled, where applicable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="property">@id</span> = <span class="literal">undefined</span> <span class="keyword">if</span> frequency <span class="keyword">is</span> -<span class="number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Start a new cycle if required.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@id</span> = setInterval <span class="property">@run</span>, frequency <span class="keyword">if</span> frequency <span class="keyword">isnt</span> -<span class="number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Run the initial process.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@run</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Core of the update manager which actually performs the update process.<br>This process updates all orders and ensures the results are reflected in the
popup.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  run: -&gt;
    progress  = <span class="number">0</span>
    <span class="property">@updating</span> = <span class="literal">yes</span></pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Update the UI to show that I&#39;m busy.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    notify()
    updatePopup()</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Called when the AJAX request has been parsed and read for each order.<br>This should be called regardless of errors being encountered.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="function"><span class="title">updated</span></span> = (order) -&gt;
      progress++</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Check if all orders have been updated; supports no orders.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> progress &gt;= ext.orders.length
        <span class="property">@updating</span> = <span class="literal">no</span></pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Persist orders and update time stamp.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        utils.set <span class="string">'orders'</span>, ext.orders
        utils.set <span class="string">'lastUpdated'</span>, $.now()</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Update the UI again to reflect the changes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        notify()
        updatePopup()</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Now read the message stack.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>[message]?() <span class="keyword">for</span> message <span class="keyword">in</span> <span class="property">@messages</span>
        <span class="property">@messages</span> = []</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Finish this now since no orders exist.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    updated.apply <span class="keyword">this</span> <span class="keyword">unless</span> ext.orders.length</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Update each order by parsing its page on the Apple US store.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    updateOrder order, updated <span class="keyword">for</span> order <span class="keyword">in</span> ext.orders</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Start the update manager, which may run once or start a repeating cycle
based on the current update frequency.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  start: -&gt;
    frequency = utils.get <span class="string">'frequency'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Clear the current cycle, where applicable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> frequency <span class="keyword">is</span> -<span class="number">1</span>
      <span class="keyword">if</span> <span class="property">@id</span>
        clearInterval <span class="property">@id</span>
        <span class="property">@id</span> = <span class="literal">undefined</span>
    <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>I start twice for no one... see RESTART for that.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">return</span> <span class="keyword">if</span> <span class="property">@id</span></pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Start a new cycle.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="property">@id</span> = setInterval <span class="property">@run</span>, frequency</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>Run the initial process.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@run</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Stop the update manager.<br>If this is called during an active update process the manager will stop upon
completion.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  stop: -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>I&#39;m busy; I&#39;ll do it later.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> <span class="property">@messages</span>.push <span class="string">'stop'</span> <span class="keyword">if</span> <span class="property">@updating</span></pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>Clear the current cycle, where possible.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> <span class="property">@id</span>
      clearInterval <span class="property">@id</span>
      <span class="property">@id</span> = <span class="literal">undefined</span></pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <h3>Background page setup</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>ext = window.ext =</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <h3>Public constants</h3>
<p>Details for the supported update frequencies.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  FREQUENCIES: [
    text:  utils.i18n <span class="string">'freq_disabled'</span>
    value: -<span class="number">1</span>
  ,
    text:  utils.i18n <span class="string">'freq_minutes'</span>, <span class="string">'15'</span>
    value: <span class="number">15</span> * <span class="number">60</span> * <span class="number">1000</span>
  ,
    text:  utils.i18n <span class="string">'freq_minutes'</span>, <span class="string">'30'</span>
    value: <span class="number">30</span> * <span class="number">60</span> * <span class="number">1000</span>
  ,
    text:  utils.i18n <span class="string">'freq_minutes'</span>, <span class="string">'45'</span>
    value: <span class="number">45</span> * <span class="number">60</span> * <span class="number">1000</span>
  ,
    text:  utils.i18n <span class="string">'freq_hour'</span>
    value: <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>
  ,
    text:  utils.i18n <span class="string">'freq_hours'</span>, <span class="string">'2'</span>
    value: <span class="number">2</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>
  ]</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <h3>Public variables</h3>
<p>List of orders currently being maintained.<br>This should always be an exact reflection of the orders persisted in
<code>localStorage</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  orders:    []</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>Pre-prepared HTML for the popup to be populated using.<br>This should be updated whenever orders are changed/updated in any way as
this is generated to improve performance and load times of the popup frame.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  popupHtml: <span class="string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <h3>Public functions</h3>
<p>Attempt to return the order whose details match the specified criteria.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getOrder: (number, code) -&gt;
    <span class="keyword">for</span> order <span class="keyword">in</span> ext.orders <span class="keyword">when</span> order.number <span class="keyword">is</span> number <span class="keyword">and</span> order.code <span class="keyword">is</span> code
      <span class="keyword">return</span> order</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>Initialize the background page.<br>This will involve initializing the settings, adding the request listeners
and starting the update manager.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  init: -&gt;
    utils.init <span class="string">'update_progress'</span>, {}
    init_update()
    utils.init <span class="string">'badges'</span>, <span class="literal">on</span>
    utils.init <span class="string">'frequency'</span>, ext.FREQUENCIES[<span class="number">1</span>].value
    utils.init <span class="string">'lastRead'</span>, $.now()
    utils.init <span class="string">'lastUpdated'</span>, $.now()
    utils.init <span class="string">'notifications'</span>, <span class="literal">on</span>
    utils.init <span class="string">'notificationDuration'</span>, <span class="number">6</span> * <span class="number">1000</span>
    initOrders()
    chrome.extension.onRequest.addListener onRequest</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>It&#39;s nice knowing what version is running.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $.getJSON chrome.extension.getURL(<span class="string">'manifest.json'</span>), (data) -&gt;
      version = data.version</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>Execute content scripts now that we know the version.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      executeScriptsInExistingWindows()</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>It&#39;s alive!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    updateManager.start()</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>Initialize <code>ext</code> when the DOM is ready.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>utils.ready -&gt; ext.init()</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
